<template>
  <div class="w-full mx-auto p-6 bg-white rounded-lg shadow-lg">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-blue-600 mb-2">ü©∫ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏∏‡∏ô</h1>
      <p class="text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</p>
    </div>

    <div v-if="currentStep === 1" class="space-y-6">
      <div class="bg-blue-50 p-6 rounded-lg">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button @click="selectUserType('owner')"
            class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors">
            <div class="text-center">
              <div class="text-4xl mb-2">üë§</div>
              <div class="font-semibold text-gray-800">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
              <div class="text-sm text-gray-600">‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
            </div>
          </button>

          <button @click="selectUserType('other')"
            class="p-4 border-2 border-green-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-colors">
            <div class="text-center">
              <div class="text-4xl mb-2">üë•</div>
              <div class="font-semibold text-gray-800">‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô</div>
              <div class="text-sm text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</div>
            </div>
          </button>
        </div>
      </div>
    </div>

    <div v-if="currentStep === 2 && userType === 'other'" class="space-y-6">
      <div class="bg-gray-50 p-6 rounded-lg">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
            <input v-model="otherUserData.name" type="text"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
            <input v-model.number="otherUserData.age" type="number"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏" min="1" max="120" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏û‡∏®</label>
            <select v-model="otherUserData.gender"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
              <option value="male">‡∏ä‡∏≤‡∏¢</option>
              <option value="female">‡∏´‡∏ç‡∏¥‡∏á</option>
              <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
            <input v-model.number="otherUserData.weight" type="number"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å" min="1" max="500" step="0.1" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
            <input v-model.number="otherUserData.height" type="number"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á" min="50" max="250" />
          </div>
        </div>

        <div class="flex justify-between mt-6">
          <button @click="goBack"
            class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
            ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
          </button>
          <button @click="analyzeSymptoms" :disabled="!isUserDataValid || isAnalyzing"
            class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
            <span v-if="isAnalyzing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>
            <span v-else>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
          </button>
        </div>
      </div>
    </div>

    <div v-if="currentStep === 2 && userType === 'owner'" class="space-y-6">
      <div class="bg-blue-50 p-6 rounded-lg">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-white p-3 rounded border">
            <div class="text-sm text-gray-600">‡∏ä‡∏∑‡πà‡∏≠</div>
            <div class="font-semibold">{{ ownerData.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
          </div>
          <div class="bg-white p-3 rounded border">
            <div class="text-sm text-gray-600">‡∏≠‡∏≤‡∏¢‡∏∏</div>
            <div class="font-semibold">{{ ownerData.age ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }} <template v-if="ownerData.age">‡∏õ‡∏µ</template>
            </div>
          </div>
          <div class="bg-white p-3 rounded border">
            <div class="text-sm text-gray-600">‡πÄ‡∏û‡∏®</div>
            <div class="font-semibold">{{ getGenderText(ownerData.gender) }}</div>
          </div>
          <div class="bg-white p-3 rounded border">
            <div class="text-sm text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
            <div class="font-semibold">{{ ownerData.weight ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }} <template
                v-if="ownerData.weight">‡∏Å‡∏Å.</template></div>
          </div>
          <div class="bg-white p-3 rounded border md:col-span-2">
            <div class="text-sm text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</div>
            <div class="font-semibold">{{ ownerData.height ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }} <template
                v-if="ownerData.height">‡∏ã‡∏°.</template></div>
          </div>
        </div>

        <div class="flex justify-between mt-6">
          <button @click="goBack"
            class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
            ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
          </button>
          <button @click="analyzeSymptoms" :disabled="isAnalyzing"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
            <span v-if="isAnalyzing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>
            <span v-else>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
          </button>
        </div>
      </div>
    </div>

    <div v-if="currentStep === 4 && (isAnalyzing || analysisResult)" class="space-y-6">
      <div class="relative bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-xl shadow-md border border-purple-100">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent flex items-center gap-3">
            ü§ñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏∏‡∏ô
          </h2>
          <div class="flex items-center gap-2">
            <button v-if="isAnalyzing" @click="resetAnalysis"
              class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-200 shadow-md hover:shadow-lg">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
          </div>
        </div>

        <!-- Premium Loading State -->
        <div v-if="isAnalyzing" class="relative">
          <!-- Animated Background -->
          <div class="absolute inset-0 bg-gradient-to-r from-purple-100 via-indigo-100 to-blue-100 rounded-xl opacity-50 animate-pulse"></div>
          
          <!-- Main Loading Container -->
          <div class="relative bg-white/80 backdrop-blur-sm p-8 rounded-xl border border-purple-200 shadow-lg">
            <!-- AI Brain Animation -->
            <div class="flex flex-col items-center justify-center space-y-6">
              <div class="relative">
                <!-- Outer spinning ring -->
                <div class="w-20 h-20 border-4 border-purple-200 rounded-full animate-spin">
                  <div class="absolute top-2 left-2 w-2 h-2 bg-purple-600 rounded-full animate-pulse"></div>
                  <div class="absolute top-2 right-2 w-2 h-2 bg-indigo-600 rounded-full animate-pulse delay-300"></div>
                  <div class="absolute bottom-2 left-2 w-2 h-2 bg-blue-600 rounded-full animate-pulse delay-500"></div>
                  <div class="absolute bottom-2 right-2 w-2 h-2 bg-purple-600 rounded-full animate-pulse delay-700"></div>
                </div>
                
                <!-- Inner AI brain -->
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="text-3xl animate-bounce">üß†</div>
                </div>
              </div>
              
              <!-- Status Text -->
              <div class="text-center space-y-3">
                <h3 class="text-xl font-bold text-purple-800">‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏∏‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                
                <!-- Time Indicator -->
                <div class="flex items-center justify-center space-x-2 text-sm text-purple-500">
                  <svg class="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1-5 ‡∏ô‡∏≤‡∏ó‡∏µ</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Container -->
        <div v-if="!isAnalyzing && analysisResult" 
             ref="resultBox" 
             class="bg-white/90 backdrop-blur-sm p-6 rounded-xl border-l-4 border-purple-500 shadow-lg max-h-[60vh] overflow-auto">
          <div class="prose max-w-none" v-html="renderedAnalysis"></div>
        </div>

        <!-- Warning Box -->
        <div v-if="!isAnalyzing && analysisResult" 
             class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 p-4 rounded-xl mt-6 shadow-sm">
          <div class="flex">
            <div class="text-red-600 mr-3 text-lg">‚ö†Ô∏è</div>
            <div class="text-sm text-red-800">
              <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
              ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mt-6">
          <button @click="resetAnalysis"
            class="px-6 py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-md hover:shadow-lg">
            ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
// ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á: npm i marked dompurify
import { ref, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'
import { marked } from 'marked'
import DOMPurify from 'dompurify'

// üëâ ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ Pinia/Store ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏î‡∏¥‡∏°: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô path ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
import { useUserStore } from '#imports'

/** =========================
 * Config/Env
 * ========================= */
const config = useRuntimeConfig();
const AGENT_URL = config.public.AGENT_API_URL || 'http://127.0.0.1:8000/';
const API_URL = (AGENT_URL) + 'agent/analyze'
const props = defineProps({
  recordId: {
    type: String,
    required: true,
  }
});

/** =========================
 * State
 * ========================= */
const currentStep = ref(1)
const userType = ref('')
const isAnalyzing = ref(false)
const analysisResult = ref('')
const autoScroll = ref(true)
const resultBox = ref(null)

// Loading animation states
const currentStepIndex = ref(0)

const userStore = useUserStore()

const ownerData = ref({
  name: '',
  age: undefined,
  gender: undefined,
  weight: undefined,
  height: undefined
})

const otherUserData = ref({
  name: '',
  age: null,
  gender: '',
  weight: null,
  height: null
})

/** =========================
 * Loading Animation
 * ========================= */
let loadingInterval = null

function startLoadingAnimation() {
  currentStepIndex.value = 0
}

function stopLoadingAnimation() {
  if (loadingInterval) {
    clearInterval(loadingInterval)
    loadingInterval = null
  }
  currentStepIndex.value = 0
}

/** =========================
 * Hydrate owner from store
 * ========================= */
function hydrateOwnerFromStore() {
  const p = userStore || {}
  const fullName = [p.firstname, p.lastname].filter(Boolean).join(' ').trim() || userStore?.username || ''
  ownerData.value = {
    name: fullName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
    age: p.age,
    gender: p.gender,
    weight: p.weight,
    height: p.height
  }
}

/** =========================
 * Computed
 * ========================= */
const isUserDataValid = computed(() => {
  const d = otherUserData.value
  return !!(d.name && d.age && d.gender && d.weight && d.height)
})
const currentUserData = computed(() => (userType.value === 'owner' ? ownerData.value : otherUserData.value))

/** =========================
 * Navigation
 * ========================= */
const selectUserType = (type) => {
  userType.value = type
  currentStep.value = 2
}
const goBack = () => {
  if (currentStep.value === 4) {
    currentStep.value = 2
    return
  }
  if (currentStep.value > 1) currentStep.value--
}
const resetAnalysis = () => {
  stopStreaming()
  stopLoadingAnimation()
  currentStep.value = 1
  userType.value = ''
  analysisResult.value = ''
  otherUserData.value = { name: '', age: null, gender: '', weight: null, height: null }
  hydrateOwnerFromStore()
}

/** =========================
 * Utils
 * ========================= */
const getGenderText = (gender) => {
  if (!gender) {
    return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  }
  const map = { male: '‡∏ä‡∏≤‡∏¢', female: '‡∏´‡∏ç‡∏¥‡∏á', other: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' };
  return map[gender.toLowerCase()] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
}

function mdToSafeHtml(md) {
  const html = marked(md || '', { gfm: true, breaks: true })
  return DOMPurify.sanitize(html, { USE_PROFILES: { html: true } })
}
const renderedAnalysis = computed(() => mdToSafeHtml(analysisResult.value))

/** =========================
 * Token helpers
 * ========================= */
function readCookie(name) {
  const m = document.cookie.match(new RegExp('(^|; )' + encodeURIComponent(name) + '=([^;]*)'))
  return m ? decodeURIComponent(m[2]) : ''
}

function getAccessToken() {
  const s = sessionStorage.getItem('accessToken')
  if (s) return s
  if (userStore?.accessToken) return userStore.accessToken
  const c = readCookie('AccessToken')
  if (c) return c
  return ''
}

/** =========================
 * Streaming helpers
 * ========================= */
const decoder = new TextDecoder('utf-8', { fatal: false })
let pendingText = ''
let rafScheduled = false

function scheduleFlush() {
  if (rafScheduled) return
  rafScheduled = true
  requestAnimationFrame(async () => {
    if (pendingText) {
      analysisResult.value += pendingText
      pendingText = ''
      await nextTick()
      if (autoScroll.value && resultBox.value) {
        resultBox.value.scrollTop = resultBox.value.scrollHeight
      }
    }
    rafScheduled = false
  })
}

function normalizeChunk(raw) {
  let text = raw.replace(/^\uFEFF/, '')
  if (text.includes('data:')) {
    const lines = text.split(/\r?\n/).filter(Boolean)
    const payloads = []
    for (const ln of lines) {
      if (ln.startsWith('data:')) payloads.push(ln.slice(5).trimStart())
    }
    text = payloads.join('\n')
  }
  return text
}

async function streamToResult(readable) {
  const reader = readable.getReader()
  try {
    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      const chunk = decoder.decode(value, { stream: true })
      const clean = normalizeChunk(chunk)
      if (!clean) continue
      pendingText += clean
      scheduleFlush()
    }
    const final = decoder.decode()
    if (final) {
      pendingText += normalizeChunk(final)
      scheduleFlush()
    }
  } finally {
    scheduleFlush()
  }
}

/** =========================
 * Abort/Timeout
 * ========================= */
let controller = null
let timeoutId = null
const STREAM_TIMEOUT_MS = 120000

function startTimeout() {
  clearTimeout(timeoutId)
  timeoutId = setTimeout(() => {
    stopStreaming()
    friendlyError('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (timeout) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á')
  }, STREAM_TIMEOUT_MS)
}

function clearAllTimers() {
  clearTimeout(timeoutId)
  timeoutId = null
}

function stopStreaming() {
  clearAllTimers()
  stopLoadingAnimation()
  if (controller) {
    controller.abort()
    controller = null
  }
  isAnalyzing.value = false
}

function friendlyError(msg) {
  const banner =
    `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå AI ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
----------------------------------------
${msg}
‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á

`
  analysisResult.value += (analysisResult.value.endsWith('\n') ? '' : '\n') + banner
}

/** =========================
 * Actions
 * ========================= */
const analyzeSymptoms = async () => {
  isAnalyzing.value = true
  analysisResult.value = ''
  currentStep.value = 4
  startLoadingAnimation()

  const userData = currentUserData.value
  const prompt =
    `‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡∏õ‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ:` +
    `‡∏ä‡∏∑‡πà‡∏≠: ${userData.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}, ‡∏≠‡∏≤‡∏¢‡∏∏: ${userData.age ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏õ‡∏µ, ‡πÄ‡∏û‡∏®: ${getGenderText(userData.gender)}, ` +
    `‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${userData.weight ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏Å‡∏Å., ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á: ${userData.height ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏ã‡∏°. ` + `‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ record id = ${props.recordId}`

  console.log(prompt);

  const token = getAccessToken()
  if (!token) {
    isAnalyzing.value = false
    stopLoadingAnimation()
    friendlyError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (No Token Found)')
    return
  }

  try {
    controller = new AbortController()
    startTimeout()

    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ prompt }),
      signal: controller.signal
    })

    if (!response.ok) {
      stopStreaming()
      friendlyError(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (HTTP ${response.status})`)
      return
    }
    if (!response.body) {
      stopStreaming()
      friendlyError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå')
      return
    }

    await streamToResult(response.body)
  } catch (err) {
    if (err?.name === 'AbortError') {
      // User aborted, handled by resetAnalysis/stopStreaming
    } else {
      friendlyError(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢: ${(err && err.message) || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`)
    }
  } finally {
    stopStreaming()
  }
}

/** =========================
 * Lifecycle
 * ========================= */
onMounted(() => {
  hydrateOwnerFromStore()
})
onBeforeUnmount(() => {
  stopStreaming()
})
</script>

<style scoped>
.prose {
  line-height: 1.7;
}

.animate-spin {
  animation: spin 1s linear infinite;
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.animate-bounce {
  animation: bounce 1s infinite;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: .5;
  }
}

@keyframes bounce {
  0%, 100% {
    transform: translateY(-25%);
    animation-timing-function: cubic-bezier(0.8,0,1,1);
  }
  50% {
    transform: none;
    animation-timing-function: cubic-bezier(0,0,0.2,1);
  }
}

/* Gradient animations */
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.bg-gradient-to-r {
  background-size: 200% 200%;
  animation: gradientShift 6s ease infinite;
}
</style>