<template>
  <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <div v-if="loading" class="text-center py-20">
        <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</p>
      </div>

      <div v-else-if="error" class="text-center py-20">
        <p class="text-red-600 font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {{ error }}</p>
        <button @click="goBack" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      </div>

      <div v-else-if="resultData">

        <div class="mb-4">
          <button @click="goBack"
            class="inline-flex items-center gap-x-1.5 rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-200 hover:bg-gray-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
          </button>
        </div>

        <div class="mb-8">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-3xl font-bold text-gray-900 mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏õ‡∏≠‡∏î</h1>
              <p class="text-gray-600">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏≠‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
            </div>
            <button @click="handleDownloadPdf"
              class="flex items-center justify-center gap-x-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 px-4 py-2.5 font-semibold text-white shadow-lg transition-all hover:shadow-xl hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</span>
            </button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                  </path>
                </svg>
              </div>
              <div>
                <p class="text-sm text-gray-500">‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                <p class="font-mono text-sm text-gray-800">{{ resultData.id.substring(0, 8) }}...</p>
              </div>
            </div>
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div>
                <p class="text-sm text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡∏ú‡∏•</p>
                <p class="text-sm text-gray-800">{{ formatDateTime(resultData.measuredAt) }}</p>
              </div>
            </div>
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                  </path>
                </svg>
              </div>
              <div>
                <p class="text-sm text-gray-500">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
                <p class="text-sm text-gray-800">{{ resultData.machine.deviceName }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500">SpO2</p>
                <p class="text-3xl font-bold text-red-600">{{ resultData.spo2 }}%</p>
                <p class="text-sm text-green-600 mt-1">{{ getSpO2Status(resultData.spo2) }}</p>
              </div>
              <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                  </path>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500">FEV1</p>
                <p class="text-3xl font-bold text-blue-600">{{ resultData.fev1 }} ‡∏•.</p>
                <p class="text-sm text-gray-600 mt-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
              </div>
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z">
                  </path>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500">FVC</p>
                <p class="text-3xl font-bold text-green-600">{{ resultData.fvc }} ‡∏•.</p>
                <p class="text-sm text-gray-600 mt-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà</p>
              </div>
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11">
                  </path>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500">PEF</p>
                <p class="text-3xl font-bold text-purple-600">{{ resultData.pef }} ‡∏•./‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
                <p class="text-sm text-gray-600 mt-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
              </div>
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012-2z">
                  </path>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏õ‡∏≠‡∏î</h3>
            <div class="h-80">
              <canvas ref="lungFunctionChart"></canvas>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (SpO2)</h3>
            <div class="h-80 flex items-center justify-center">
              <div class="relative w-64 h-64">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                  <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"></circle>
                  <circle cx="50" cy="50" r="45" fill="none" stroke="#ef4444" stroke-width="8" stroke-linecap="round"
                    :stroke-dasharray="circumference"
                    :stroke-dashoffset="circumference - (resultData.spo2 / 100) * circumference"
                    class="transition-all duration-1000 ease-out"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="text-center">
                    <div class="text-3xl font-bold text-gray-900">{{ resultData.spo2 }}%</div>
                    <div class="text-sm text-gray-500">‡∏£‡∏∞‡∏î‡∏±‡∏ö SpO2</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô FEV1/FVC ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
          <h3 class="text-xl font-semibold text-gray-900 mb-6">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô FEV1/FVC</h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô FEV1/FVC ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° -->
            <div class="flex items-center justify-center">
              <div class="relative w-80 h-80">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                  <!-- ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
                  <circle cx="50" cy="50" r="40" fill="none" stroke="#f3f4f6" stroke-width="10"></circle>
                  <!-- ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ -->
                  <circle cx="50" cy="50" r="40" fill="none" :stroke="getRatioColor(parseFloat(resultData.fev1Fvc))"
                    stroke-width="10" stroke-linecap="round" :stroke-dasharray="251.33"
                    :stroke-dashoffset="251.33 - (parseFloat(resultData.fev1Fvc) * 251.33)"
                    class="transition-all duration-1000 ease-out"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="text-center">
                    <div class="text-4xl font-bold text-gray-900">{{ resultData.fev1Fvc }}</div>
                    <div class="text-lg font-medium text-gray-600 mt-2">FEV1/FVC ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô</div>
                    <div :class="'text-sm font-semibold mt-2 ' + getRatioColorClass(parseFloat(resultData.fev1Fvc))">
                      {{ getRatioStatus(parseFloat(resultData.fev1Fvc)) }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏ú‡∏• -->
            <div class="space-y-6">
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                <h4 class="font-bold text-blue-900 mb-4 text-lg">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-blue-800">FEV1:</span>
                    <span class="font-semibold text-blue-900">{{ resultData.fev1 }} ‡∏•‡∏¥‡∏ï‡∏£</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-blue-800">FVC:</span>
                    <span class="font-semibold text-blue-900">{{ resultData.fvc }} ‡∏•‡∏¥‡∏ï‡∏£</span>
                  </div>
                  <div class="border-t border-blue-200 pt-3">
                    <div class="flex justify-between items-center">
                      <span class="text-blue-800 font-medium">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô:</span>
                      <span class="font-bold text-xl text-blue-900">{{ resultData.fev1Fvc }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="bg-gray-50 rounded-lg p-6">
                <h4 class="font-bold text-gray-900 mb-4 text-lg">‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏ú‡∏•</h4>
                <div class="space-y-3">
                  <div class="flex items-center justify-between p-3 bg-green-100 rounded-lg">
                    <span class="text-green-800 font-medium">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                    <span class="text-green-900 font-semibold">> 0.75</span>
                  </div>
                  <div class="flex items-center justify-between p-3 bg-yellow-100 rounded-lg">
                    <span class="text-yellow-800 font-medium">‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span>
                    <span class="text-yellow-900 font-semibold">0.60 - 0.75</span>
                  </div>
                  <div class="flex items-center justify-between p-3 bg-orange-100 rounded-lg">
                    <span class="text-orange-800 font-medium">‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
                    <span class="text-orange-900 font-semibold">0.45 - 0.60</span>
                  </div>
                  <div class="flex items-center justify-between p-3 bg-red-100 rounded-lg">
                    <span class="text-red-800 font-medium">‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</span>
                    <span class="text-red-900 font-semibold">
                      < 0.45</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
          <h3 class="text-xl font-semibold mb-4">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold mb-2">‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</h4>
              <ul class="space-y-2">
                <li v-for="recommendation in getRecommendations()" :key="recommendation"
                  class="flex items-start space-x-2">
                  <svg class="w-5 h-5 mt-0.5 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span class="text-sm">{{ recommendation }}</span>
                </li>
              </ul>
            </div>
            <div>
            </div>
          </div>
        </div> -->
        <PulmonaryFunctionTable class="mt-8" />
        <NongKunAnalyst class="mt-5" :record-id="route.params.id" />
      </div>
    </div>
  </div>
</template>

<script setup>

import { onMounted, nextTick, ref } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useRecordApi } from '~/composable/record/get-record';
import NongKunAnalyst from '~/conponents/NongKunAnalyst.vue';
import PulmonaryFunctionTable from '~/conponents/PulmonaryFunctionTable.vue';
// ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ useAuthStore
import { useUserStore } from '#imports';
const router = useRouter();
const route = useRoute();
const { $swal } = useNuxtApp();

const {
  record: resultData,
  loading,
  error,
  fetchRecordById,
  downloadReportPdf
} = useRecordApi();

// ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å useAuthStore)
const userStore = useUserStore();

const CurrentUser = {
  name: userStore.fullName,
  age: userStore.age,
  gender: userStore.gender,
  height: userStore.height,
  weight: userStore.weight
}

const goBack = () => {
  router.back();
}

const lungFunctionChart = ref(null);
const circumference = 2 * Math.PI * 45;

const formatDateTime = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleString('th-TH', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

const getSpO2Status = (spo2) => {
  if (spo2 >= 95) return '‡∏õ‡∏Å‡∏ï‡∏¥';
  if (spo2 >= 90) return '‡∏†‡∏≤‡∏ß‡∏∞‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡πà‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
  if (spo2 >= 85) return '‡∏†‡∏≤‡∏ß‡∏∞‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡πà‡∏≥‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
  return '‡∏†‡∏≤‡∏ß‡∏∞‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡πà‡∏≥‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á';
}

const getRatioStatus = (ratio) => {
  if (ratio > 0.75) return '‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏õ‡∏≠‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
  if (ratio >= 0.60) return '‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
  if (ratio >= 0.45) return '‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
  return '‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á';
}

const getRatioColor = (ratio) => {
  if (ratio > 0.75) return '#10b981'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß - ‡∏õ‡∏Å‡∏ï‡∏¥
  if (ratio >= 0.60) return '#f59e0b'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á - ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
  if (ratio >= 0.45) return '#f97316'; // ‡∏™‡πâ‡∏° - ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
  return '#ef4444'; // ‡πÅ‡∏î‡∏á - ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
}

const getRatioColorClass = (ratio) => {
  if (ratio > 0.75) return 'text-green-600';
  if (ratio >= 0.60) return 'text-yellow-600';
  if (ratio >= 0.45) return 'text-orange-600';
  return 'text-red-600';
}

const initCharts = async () => {
  if (!resultData.value) return;

  await nextTick();
  const { Chart, registerables } = await import('chart.js');
  Chart.register(...registerables);

  if (window.myLungChart) window.myLungChart.destroy();

  if (lungFunctionChart.value) {
    window.myLungChart = new Chart(lungFunctionChart.value, {
      type: 'bar',
      data: {
        labels: ['FEV1 (‡∏•‡∏¥‡∏ï‡∏£)', 'FVC (‡∏•‡∏¥‡∏ï‡∏£)', 'PEF (‡∏•‡∏¥‡∏ï‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô FEV1/FVC'],
        datasets: [{
          label: '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
          data: [
            parseFloat(resultData.value.fev1),
            parseFloat(resultData.value.fvc),
            parseFloat(resultData.value.pef),
            parseFloat(resultData.value.fev1Fvc)
          ],
          backgroundColor: [
            'rgba(59, 130, 246, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(139, 92, 246, 0.8)',
            'rgba(245, 101, 101, 0.8)'
          ],
          borderColor: [
            'rgb(59, 130, 246)',
            'rgb(16, 185, 129)',
            'rgb(139, 92, 246)',
            'rgb(245, 101, 101)'
          ],
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.1)' } },
          x: { grid: { display: false } }
        }
      }
    });
  }
}

const handleDownloadPdf = async () => {
  const recordId = route.params.id;
  if (!recordId) return;

  // 1. ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô - ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
  const { value: recipientType } = await $swal.fire({
    title: '<strong>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£?</strong>',
    html: `
      <div class="mt-4 space-y-4">
        <div class="flex flex-col gap-4">
          <label class="relative flex items-center p-4 rounded-lg border-2 border-gray-200 cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all duration-200">
            <input type="radio" name="recipient" value="current" class="sr-only">
            <div class="flex items-center justify-center w-5 h-5 border-2 border-blue-500 rounded-full mr-4">
              <div class="w-3 h-3 bg-blue-500 rounded-full opacity-0 transition-opacity duration-200"></div>
            </div>
            <div class="flex-1 text-left">
              <div class="font-semibold text-gray-900">üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
              <div class="text-sm text-gray-500">‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            </div>
          </label>
          
          <label class="relative flex items-center p-4 rounded-lg border-2 border-gray-200 cursor-pointer hover:bg-green-50 hover:border-green-300 transition-all duration-200">
            <input type="radio" name="recipient" value="other" class="sr-only">
            <div class="flex items-center justify-center w-5 h-5 border-2 border-green-500 rounded-full mr-4">
              <div class="w-3 h-3 bg-green-500 rounded-full opacity-0 transition-opacity duration-200"></div>
            </div>
            <div class="flex-1 text-left">
              <div class="font-semibold text-gray-900">üë• ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏∑‡πà‡∏ô</div>
              <div class="text-sm text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            </div>
          </label>
        </div>
      </div>
    `,
    width: '500px',
    showCancelButton: true,
    confirmButtonText: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
    confirmButtonColor: '#3b82f6',
    cancelButtonColor: '#ef4444',
    customClass: {
      popup: 'rounded-2xl shadow-2xl',
      title: 'text-xl',
      confirmButton: 'rounded-lg px-6 py-2 font-medium',
      cancelButton: 'rounded-lg px-6 py-2 font-medium'
    },
    didOpen: () => {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö custom radio buttons
      const radioInputs = document.querySelectorAll('input[name="recipient"]');
      const radioVisuals = document.querySelectorAll('.w-3.h-3');
      
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      radioInputs[0].checked = true;
      radioVisuals[0].classList.remove('opacity-0');
      
      radioInputs.forEach((input, index) => {
        input.addEventListener('change', () => {
          radioVisuals.forEach(visual => visual.classList.add('opacity-0'));
          if (input.checked) {
            radioVisuals[index].classList.remove('opacity-0');
          }
        });
      });
    },
    preConfirm: () => {
      const selectedRadio = document.querySelector('input[name="recipient"]:checked');
      if (!selectedRadio) {
        $swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
        return false;
      }
      return selectedRadio.value;
    }
  });

  if (!recipientType) return;

  let reportBody = {};
  let userData = {};
  let isCurrentUser = recipientType === 'current';

  if (isCurrentUser) {
    userData = CurrentUser;
  } else {
    // 2. Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏∑‡πà‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
    const { value: formValues } = await $swal.fire({
      title: '<strong>üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</strong>',
      html: `
        <div class="mt-6 space-y-5">
          <!-- ‡∏ä‡∏∑‡πà‡∏≠ -->
          <div class="text-left">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-user mr-2"></i>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            </label>
            <input 
              id="patient-name" 
              type="text" 
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors duration-200" 
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
              maxlength="100"
            >
            <div class="text-xs text-red-500 mt-1 hidden" id="name-error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
          </div>

          <!-- ‡∏≠‡∏≤‡∏¢‡∏∏ -->
          <div class="text-left">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-birthday-cake mr-2"></i>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)
            </label>
            <input 
              id="patient-age" 
              type="number" 
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors duration-200" 
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏"
              min="1" 
              max="150"
            >
            <div class="text-xs text-red-500 mt-1 hidden" id="age-error">‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-150 ‡∏õ‡∏µ</div>
          </div>

          <!-- ‡πÄ‡∏û‡∏® -->
          <div class="text-left">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-venus-mars mr-2"></i>‡πÄ‡∏û‡∏®
            </label>
            <select 
              id="patient-gender" 
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors duration-200"
            >
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
              <option value="‡∏ä‡∏≤‡∏¢">üë® ‡∏ä‡∏≤‡∏¢</option>
              <option value="‡∏´‡∏ç‡∏¥‡∏á">üë© ‡∏´‡∏ç‡∏¥‡∏á</option>
            </select>
            <div class="text-xs text-red-500 mt-1 hidden" id="gender-error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</div>
          </div>

          <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å -->
          <div class="grid grid-cols-2 gap-4">
            <div class="text-left">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-ruler-vertical mr-2"></i>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)
              </label>
              <input 
                id="patient-height" 
                type="number" 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors duration-200" 
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 165"
                min="50" 
                max="250"
              >
              <div class="text-xs text-red-500 mt-1 hidden" id="height-error">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 50-250 ‡∏ã‡∏°.</div>
            </div>
            
            <div class="text-left">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-weight mr-2"></i>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)
              </label>
              <input 
                id="patient-weight" 
                type="number" 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors duration-200" 
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 60"
                min="10" 
                max="300"
              >
              <div class="text-xs text-red-500 mt-1 hidden" id="weight-error">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 10-300 ‡∏Å‡∏Å.</div>
            </div>
          </div>
        </div>
      `,
      width: '600px',
      focusConfirm: false,
      confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
      cancelButtonText: '‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö',
      confirmButtonColor: '#10b981',
      cancelButtonColor: '#6b7280',
      customClass: {
        popup: 'rounded-2xl shadow-2xl',
        title: 'text-xl',
        htmlContainer: 'text-left',
        confirmButton: 'rounded-lg px-6 py-2 font-medium',
        cancelButton: 'rounded-lg px-6 py-2 font-medium'
      },
      didOpen: () => {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Font Awesome ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
        if (!document.querySelector('link[href*="font-awesome"]')) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
          document.head.appendChild(link);
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° real-time validation
        const inputs = ['name', 'age', 'gender', 'height', 'weight'];
        inputs.forEach(inputName => {
          const element = document.getElementById(`patient-${inputName}`);
          if (element) {
            element.addEventListener('input', () => validateField(inputName));
            element.addEventListener('blur', () => validateField(inputName));
          }
        });
      },
      preConfirm: () => {
        const name = document.getElementById('patient-name').value.trim();
        const age = parseInt(document.getElementById('patient-age').value);
        const gender = document.getElementById('patient-gender').value;
        const height = parseInt(document.getElementById('patient-height').value);
        const weight = parseInt(document.getElementById('patient-weight').value);

        let isValid = true;
        
        // Validate ‡∏ä‡∏∑‡πà‡∏≠
        if (!name || name.length < 2) {
          showFieldError('name', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
          isValid = false;
        }

        // Validate ‡∏≠‡∏≤‡∏¢‡∏∏
        if (!age || age < 1 || age > 150) {
          showFieldError('age', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-150 ‡∏õ‡∏µ');
          isValid = false;
        }

        // Validate ‡πÄ‡∏û‡∏®
        if (!gender) {
          showFieldError('gender', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®');
          isValid = false;
        }

        // Validate ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á
        if (!height || height < 50 || height > 250) {
          showFieldError('height', '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 50-250 ‡∏ã‡∏°.');
          isValid = false;
        }

        // Validate ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
        if (!weight || weight < 10 || weight > 300) {
          showFieldError('weight', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 10-300 ‡∏Å‡∏Å.');
          isValid = false;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö BMI ‡∏ß‡πà‡∏≤‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (height && weight) {
          const bmi = weight / Math.pow(height / 100, 2);
          if (bmi < 10 || bmi > 60) {
            $swal.showValidationMessage('‡∏Ñ‡πà‡∏≤ BMI ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            isValid = false;
          }
        }

        if (!isValid) {
          return false;
        }

        return { name, age, gender, height, weight };
      }
    });

    if (!formValues) return;
    userData = formValues;
  }

  // Helper functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö validation
  function validateField(fieldName) {
    const element = document.getElementById(`patient-${fieldName}`);
    const errorElement = document.getElementById(`${fieldName}-error`);
    
    if (!element || !errorElement) return;

    let isValid = true;
    let errorMessage = '';

    switch (fieldName) {
      case 'name':
        const name = element.value.trim();
        if (!name || name.length < 2) {
          isValid = false;
          errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)';
        }
        break;
      case 'age':
        const age = parseInt(element.value);
        if (!age || age < 1 || age > 150) {
          isValid = false;
          errorMessage = '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-150 ‡∏õ‡∏µ';
        }
        break;
      case 'gender':
        if (!element.value) {
          isValid = false;
          errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®';
        }
        break;
      case 'height':
        const height = parseInt(element.value);
        if (!height || height < 50 || height > 250) {
          isValid = false;
          errorMessage = '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 50-250 ‡∏ã‡∏°.';
        }
        break;
      case 'weight':
        const weight = parseInt(element.value);
        if (!weight || weight < 10 || weight > 300) {
          isValid = false;
          errorMessage = '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 10-300 ‡∏Å‡∏Å.';
        }
        break;
    }

    if (isValid) {
      element.classList.remove('border-red-500');
      element.classList.add('border-green-500');
      errorElement.classList.add('hidden');
    } else {
      element.classList.remove('border-green-500');
      element.classList.add('border-red-500');
      errorElement.textContent = errorMessage;
      errorElement.classList.remove('hidden');
    }

    return isValid;
  }

  function showFieldError(fieldName, message) {
    const element = document.getElementById(`patient-${fieldName}`);
    const errorElement = document.getElementById(`${fieldName}-error`);
    
    if (element && errorElement) {
      element.classList.add('border-red-500');
      element.classList.remove('border-green-500');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }
  }

  // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Body ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API Call
  reportBody = {
    patientInfo: {
      name: userData.name,
      age: userData.age,
      gender: userData.gender,
      height: userData.height,
      weight: userData.weight,
    },
    isCurrentUser: isCurrentUser
  };

  // 4. ‡πÅ‡∏™‡∏î‡∏á loading modal - ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
  $swal.fire({
    title: '<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-3"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</div>',
    html: `
      <div class="mt-4">
        <div class="bg-blue-50 rounded-lg p-4 mb-4">
          <p class="text-blue-800 font-medium">üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
          <p class="text-blue-600 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÑ‡∏ü‡∏•‡πå PDF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>${userData.name}</strong></p>
        </div>
        <div class="flex justify-center">
          <div class="animate-pulse flex space-x-1">
            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
          </div>
        </div>
      </div>
    `,
    allowOutsideClick: false,
    showConfirmButton: false,
    customClass: {
      popup: 'rounded-2xl shadow-2xl',
      title: 'text-lg'
    }
  });

  try {
    const blob = await downloadReportPdf(recordId, reportBody);

    if (blob) {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lung-function-report-${userData.name}-${new Date().toISOString().split('T')[0]}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      // Success modal - ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
      $swal.fire({
        icon: 'success',
        title: '<strong>üéâ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong>',
        html: `
          <div class="mt-4 bg-green-50 rounded-lg p-4">
            <p class="text-green-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>${userData.name}</strong> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
            <p class="text-green-600 text-sm mt-2">üìÑ ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
          </div>
        `,
        confirmButtonText: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        confirmButtonColor: '#10b981',
        customClass: {
          popup: 'rounded-2xl shadow-2xl',
          confirmButton: 'rounded-lg px-6 py-2 font-medium'
        }
      });

    } else {
      throw new Error(error.value || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÑ‡∏î‡πâ');
    }
  } catch (err) {
    console.error("Download error:", err);
    
    // Error modal - ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
    $swal.fire({
      icon: 'error',
      title: '<strong>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</strong>',
      html: `
        <div class="mt-4 bg-red-50 rounded-lg p-4">
          <p class="text-red-800 font-medium">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>
          <p class="text-red-600 text-sm mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</p>
          <div class="mt-3 text-xs text-red-500 font-mono bg-red-100 p-2 rounded">
            Error: ${err.message || 'Unknown error'}
          </div>
        </div>
      `,
      confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
      showCancelButton: true,
      cancelButtonText: '‡∏õ‡∏¥‡∏î',
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#6b7280',
      customClass: {
        popup: 'rounded-2xl shadow-2xl',
        confirmButton: 'rounded-lg px-6 py-2 font-medium',
        cancelButton: 'rounded-lg px-6 py-2 font-medium'
      }
    }).then((result) => {
      if (result.isConfirmed) {
        handleDownloadPdf(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πâ‡∏≥
      }
    });
  }
};


onMounted(async () => {
  const recordId = route.params.id;
  if (recordId) {
    await fetchRecordById(recordId);
    if (resultData.value) {
      initCharts();
    }
  } else {
    error.value = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô URL";
  }
});

definePageMeta({
  layout: 'default',
  middleware: 'auth'
});
</script>